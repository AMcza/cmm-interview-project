# 用户点赞优化

#### **需求分析**

------

判断是否需要点赞，用户是否点赞流程：批量存储用户点赞的帖子信息，进行遍历判断。

------

#### **方案设计**

------

redis存储+冷热分离+布隆过滤器

------

#### 数据结构设计

```
key: 帖子id           thumb:postid
filed: 用户id         user:userid
value: 记录id+过期时间
```

#### 过期策略

> [问题1]
>
> redis只能针对key设置过期时间，我们只想缓存用户点赞的热点数据

- 冷热分离：
  - 假定一个月以内发布的帖子是热数据，点赞帖子时，记录在redis里的过期时间+1个月。如果点赞时该帖子的发布时间超过一个月，则查询Mysql；如果帖子发布时间在一个月以内，则查询Redis


> [问题2]
>
> 如何获得帖子的发布时间

- 布隆过滤器：

  - 工作流程：添加元素  和 查询元素
    - 添加元素：
      - 假设有三个哈希函数：添加元素时，分别用三个哈希函数计算，然后使用数组长度取模，得到三个数组下标。将三个位置设置为1.
    - 查找元素：
      - 同样适用三个哈希函数，计算并取模，得到三个位置；查找三个位置的值是全部为1.
  - 业务查询：
    - key:  userId:postId  用户对帖子是否点赞

# Redis异步更新数据库

#### **需求分析**

------

问题：1.短时间大量接口执行点赞操作时，频繁写入数据库会增加负责 2.高并发情况下性能会降低 3.事务操作导致响应时间变长

------

#### **方案设计**

------

Redis缓存+定时同步模式+补偿机制

------

#### 数据结构设计

按时间戳进行分片

```
key: thumb:temp:{时间}
field: {userId}:{postId}
value: 操作类型(1:点赞;2:取消点赞;0:无变化)
```

#### 核心流程

1. 用户点赞/取消点赞时，先检查Redis中的点赞状态，将点赞记录先更新到Redis写为临时集合。
2. 定时任务：会定期从临时集合中获取数据，批量同步到数据库数据库并更新博客点赞计数
3. 补偿机制：每天凌晨自动检查并处理因系统异常导致未同步的数据。

![image-20251122192710237](C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20251122192710237.png)